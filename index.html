<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Advanced SeatMap Editor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #canvas-container {
        border: 1px solid #ccc;
        width: 100%;
        height: 100%;
        position: relative;
        background: #f0f0f0;
      }
      #sidebar {
        height: 100vh;
        overflow-y: auto;
      }
      .toolbar button {
        margin-right: 5px;
        margin-bottom: 5px;
      }
      .section-inputs {
        background-color: #eee;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Toolbar -->
        <div class="col-12 bg-light p-2 toolbar">
          <button id="rectTool" class="btn btn-sm btn-outline-primary">
            â¬› Rectangle
          </button>
          <button id="circleTool" class="btn btn-sm btn-outline-primary">
            âšª Circle
          </button>
          <button id="ellipseTool" class="btn btn-sm btn-outline-primary">
            â­• Ellipse
          </button>
          <button id="polygonTool" class="btn btn-sm btn-outline-primary">
            ðŸ”º Polygon
          </button>
          <button id="exportBtn" class="btn btn-sm btn-warning">
            ðŸ“¤ Export JSON
          </button>
          <button id="addTextBtn" class="btn btn-sm btn-warning">
            Add Text
          </button>
        </div>

        <!-- Canvas -->
        <div class="col-9 p-0" style="height: 100vh">
          <div id="canvas-container">
            <canvas id="seatCanvas"></canvas>
          </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar" class="col-3 bg-white p-3 border-start">
          <ul class="nav nav-tabs" id="sidebarTab" role="tablist">
            <li class="nav-item">
              <button
                class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#seat-plan-settings"
              >
                Seat Plan
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#seat-edit"
              >
                Seat Edit
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#price-type"
              >
                Price & Type
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#custom-settings"
              >
                Custom
              </button>
            </li>
          </ul>

          <div class="tab-content mt-2">
            <!-- Seat Plan Settings -->
            <div class="tab-pane fade show active" id="seat-plan-settings">
              <h6>Seat Plan Settings</h6>
              <div class="mb-2">
                <label>Number of Sections</label>
                <input
                  type="number"
                  id="sectionCountInput"
                  class="form-control"
                  value="1"
                  min="1"
                  max="10"
                />
              </div>
              <ul
                class="nav nav-pills mb-2"
                id="sectionTabs"
                role="tablist"
              ></ul>
              <div class="tab-content" id="sectionTabContent"></div>
              <button id="drawSeatsBtn" class="btn btn-primary w-100 mb-3">
                Draw Seats
              </button>
            </div>

            <!-- Seat Edit -->
            <div class="tab-pane fade" id="seat-edit">
              <div class="mb-2">
                <label>Section Name</label
                ><input
                  type="text"
                  id="sectionInputSidebar"
                  class="form-control"
                  readonly
                />
              </div>
              <div class="mb-2">
                <label>Row Prefix</label
                ><input
                  type="text"
                  id="rowInput"
                  class="form-control"
                  value="A"
                />
              </div>
              <div class="mb-2">
                <label>Column Number</label
                ><input
                  type="number"
                  id="numInput"
                  class="form-control"
                  value="1"
                />
              </div>
              <div class="mb-2">
                <label>Seat Name</label
                ><input
                  type="text"
                  id="seatNameInput"
                  class="form-control"
                  value=""
                />
              </div>
              <div class="mb-2">
                <label>Rows</label
                ><input
                  type="number"
                  id="gridRows"
                  class="form-control"
                  value="5"
                />
              </div>
              <div class="mb-2">
                <label>Columns</label
                ><input
                  type="number"
                  id="gridCols"
                  class="form-control"
                  value="10"
                />
              </div>
              <div class="mb-2">
                <label>Column Start</label
                ><input
                  type="number"
                  id="gridColStart"
                  class="form-control"
                  value="1"
                />
              </div>
              <div class="d-flex gap-3">
                <button id="drawSeatBtn" class="btn btn-success w-100 mb-2">
                  âž• Draw Single Seat
                </button>
                <!-- <button id="drawGridBtn" class="btn btn-primary w-100 mb-2">
                ðŸ“¦ Draw Grid
              </button> -->
                <button id="deleteBtn" class="btn btn-danger w-100 mb-2">
                  ðŸ—‘ Delete Selected
                </button>
              </div>
            </div>

            <!-- Price & Type -->
            <div class="tab-pane fade" id="price-type">
              <div class="mb-2">
                <label>Seat Type</label>
                <select id="typeInput" class="form-select"></select>
              </div>
              <div class="mb-2">
                <label>Price</label
                ><input
                  type="number"
                  id="priceInput"
                  class="form-control"
                  value="0"
                />
              </div>
              <div class="mb-2">
                <label>Add New Type</label>
                <input
                  type="text"
                  id="newTypeName"
                  class="form-control"
                  placeholder="Type Name"
                />
                <input
                  type="color"
                  id="newTypeColor"
                  class="form-control mt-1"
                  value="#4caf50"
                />
                <button
                  id="addTypeBtn"
                  class="btn btn-sm btn-success mt-1 w-100"
                >
                  Add Type
                </button>
              </div>
            </div>

            <!-- Custom -->
            <div class="tab-pane fade" id="custom-settings">
              <div class="mb-2">
                <label>Floor</label
                ><input type="text" id="floorInput" class="form-control" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const container = document.getElementById("canvas-container");
      const canvas = new fabric.Canvas("seatCanvas", {
        selection: true,
        preserveObjectStacking: true,
      });
      const gridSize = 20;

      // Seat types
      let seatTypes = {
        Standard: "#4caf50",
        VIP: "#FFD700",
        Hold: "#00BFFF",
        Disabled: "#aaa",
      };
      function refreshTypeSelect() {
        const sel = document.getElementById("typeInput");
        sel.innerHTML = "";
        Object.keys(seatTypes).forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });
      }
      refreshTypeSelect();
      document.getElementById("addTypeBtn").onclick = () => {
        const name = document.getElementById("newTypeName").value.trim();
        const color = document.getElementById("newTypeColor").value;
        if (name) {
          seatTypes[name] = color;
          refreshTypeSelect();
          document.getElementById("newTypeName").value = "";
        }
      };

      // Grid background
      function setGridBackground() {
        const gridCanvas = document.createElement("canvas");
        gridCanvas.width = canvas.getWidth();
        gridCanvas.height = canvas.getHeight();
        const ctx = gridCanvas.getContext("2d");
        ctx.fillStyle = "#f0f0f0";
        ctx.fillRect(0, 0, gridCanvas.width, gridCanvas.height);
        ctx.strokeStyle = "#ddd";
        for (let i = 0; i < gridCanvas.width; i += gridSize) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, gridCanvas.height);
          ctx.stroke();
        }
        for (let j = 0; j < gridCanvas.height; j += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, j);
          ctx.lineTo(gridCanvas.width, j);
          ctx.stroke();
        }
        canvas.setBackgroundImage(
          gridCanvas.toDataURL(),
          canvas.renderAll.bind(canvas)
        );
      }

      function resizeCanvas() {
        canvas.setWidth(container.clientWidth);
        canvas.setHeight(container.clientHeight);
        setGridBackground();
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      // Zoom
      canvas.on("mouse:wheel", function (opt) {
        if (!opt.e.ctrlKey) return;
        let zoom = canvas.getZoom();
        zoom *= 0.999 ** opt.e.deltaY;
        zoom = Math.min(Math.max(0.5, zoom), 3);
        canvas.setZoom(zoom);
        opt.e.preventDefault();
        opt.e.stopPropagation();
      });

      // Debounce
      function debounce(fn, delay) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      }

      // Section tabs UI
      const sectionCountInput = document.getElementById("sectionCountInput");
      const sectionTabs = document.getElementById("sectionTabs");
      const sectionTabContent = document.getElementById("sectionTabContent");
      let sections = [];

      function renderSectionInputs() {
        sections = [];
        sectionTabs.innerHTML = "";
        sectionTabContent.innerHTML = "";
        const count = parseInt(sectionCountInput.value) || 1;
        for (let i = 0; i < count; i++) {
          const tabButton = document.createElement("li");
          tabButton.className = "nav-item";
          tabButton.innerHTML = `<button class="nav-link ${
            i === 0 ? "active" : ""
          }" data-bs-toggle="tab" data-bs-target="#sectionTab${i}">Section ${
            i + 1
          }</button>`;
          sectionTabs.appendChild(tabButton);

          const tabPane = document.createElement("div");
          tabPane.className = `tab-pane fade ${i === 0 ? "show active" : ""}`;
          tabPane.id = `sectionTab${i}`;
          tabPane.innerHTML = `
            <div class="section-inputs">
              <label>Section ${
                i + 1
              } Name</label><input type="text" class="form-control sectionNameInput" value="Section ${
            i + 1
          }">
              <label>Rows</label><input type="number" class="form-control sectionRows" value="5">
              <label>Columns</label><input type="number" class="form-control sectionCols" value="10">
              <label>Start Column</label><input type="number" class="form-control sectionColStart" value="1">
            </div>`;
          sectionTabContent.appendChild(tabPane);

          const nameInput = tabPane.querySelector(".sectionNameInput");
          const rowsInput = tabPane.querySelector(".sectionRows");
          const colsInput = tabPane.querySelector(".sectionCols");
          const colStartInput = tabPane.querySelector(".sectionColStart");

          [nameInput, rowsInput, colsInput, colStartInput].forEach((inp) =>
            inp.addEventListener("input", debounce(drawSeats, 300))
          );

          sections.push({
            name: nameInput.value,
            rows: parseInt(rowsInput.value),
            cols: parseInt(colsInput.value),
            colStart: parseInt(colStartInput.value),
            nameInput,
            rowsInput,
            colsInput,
            colStartInput,
          });
        }
      }

      sectionCountInput.addEventListener("input", renderSectionInputs);
      renderSectionInputs();

      // Seat creation
      function createSeat(
        x,
        y,
        row,
        col,
        type = "Standard",
        price = 0,
        floor = "",
        section = "",
        seatName = ""
      ) {
        const circle = new fabric.Circle({
          left: x,
          top: y,
          radius: 15,
          fill: seatTypes[type],
          stroke: "#333",
          strokeWidth: 1,
          originX: "center",
          originY: "center",
        });
        const labelText = seatName || row + col;
        const label = new fabric.Text(labelText, {
          fontSize: 12,
          originX: "center",
          originY: "center",
          top: y,
          left: x,
          selectable: false,
        });
        const group = new fabric.Group([circle, label], {
          left: x,
          top: y,
          hasControls: false,
          lockScalingFlip: true,
        });
        group.customProps = {
          row,
          col,
          type,
          price,
          floor,
          section,
          seatName: labelText,
        };
        return group;
      }

      // Draw seats
      function drawSeats() {
        canvas.renderOnAddRemove = false;
        canvas.getObjects().forEach((o) => {
          if (o.customProps || o.sectionLabel) canvas.remove(o);
        });

        let startX = 50,
          startY = 50,
          gapX = 40,
          gapY = 40,
          sectionGap = 60;
        const floorVal = document.getElementById("floorInput").value;

        // Update sections array
        sections.forEach((sec) => {
          sec.name = sec.nameInput.value;
          sec.rows = parseInt(sec.rowsInput.value);
          sec.cols = parseInt(sec.colsInput.value);
          sec.colStart = parseInt(sec.colStartInput.value);
        });

        sections.forEach((sec) => {
          const sectionLabel = new fabric.Text(sec.name, {
            left: startX + (sec.cols * gapX) / 2,
            top: startY - 30,
            fontSize: 18,
            fontWeight: "bold",
            originX: "center",
            fill: "#333",
            selectable: true,
          });
          sectionLabel.sectionLabel = true;
          canvas.add(sectionLabel);

          for (let r = 0; r < sec.rows; r++) {
            for (let c = 0; c < sec.cols; c++) {
              const seat = createSeat(
                startX + c * gapX,
                startY + r * gapY,
                String.fromCharCode(65 + r),
                sec.colStart + c,
                "Standard",
                0,
                floorVal,
                sec.name
              );
              canvas.add(seat);
            }
          }

          startX += sec.cols * gapX + sectionGap;
        });

        canvas.renderOnAddRemove = true;
        canvas.renderAll();
      }

      document.getElementById("drawSeatsBtn").onclick = drawSeats;

      // Single seat
      document.getElementById("drawSeatBtn").onclick = () => {
        const seat = createSeat(
          100,
          100,
          document.getElementById("rowInput").value,
          document.getElementById("numInput").value,
          document.getElementById("typeInput").value,
          parseFloat(document.getElementById("priceInput").value) || 0,
          document.getElementById("floorInput").value,
          document.getElementById("sectionInputSidebar").value,
          document.getElementById("seatNameInput").value
        );
        canvas.add(seat);
        canvas.renderAll();
      };

      // Delete
      document.getElementById("deleteBtn").onclick = () => {
        canvas.getActiveObjects().forEach((o) => canvas.remove(o));
        canvas.discardActiveObject();
        canvas.renderAll();
      };
      document.addEventListener("keydown", (e) => {
        if (e.key === "Delete" || e.key === "Backspace") {
          canvas.getActiveObjects().forEach((o) => canvas.remove(o));
          canvas.discardActiveObject();
          canvas.renderAll();
        }
      });

      // Update sidebar on selection
      canvas.on("selection:created", updateSidebar);
      canvas.on("selection:updated", updateSidebar);
      canvas.on("selection:cleared", () => {
        document.getElementById("sectionInputSidebar").value = "";
      });

      function updateSidebar() {
        const objs = canvas.getActiveObjects();
        if (objs.length > 0 && objs[0].customProps) {
          document.getElementById("sectionInputSidebar").value =
            objs[0].customProps.section;
          document.getElementById("rowInput").value = objs[0].customProps.row;
          document.getElementById("numInput").value = objs[0].customProps.col;
          document.getElementById("seatNameInput").value =
            objs[0].customProps.seatName;
          document.getElementById("typeInput").value = objs[0].customProps.type;
          document.getElementById("priceInput").value =
            objs[0].customProps.price;
        }
      }

      // Apply type/color and price to selected seats live
      ["typeInput", "priceInput", "seatNameInput"].forEach((id) => {
        document.getElementById(id).addEventListener("input", () => {
          const objs = canvas.getActiveObjects();
          objs.forEach((obj) => {
            if (obj.customProps) {
              obj.customProps.type = document.getElementById("typeInput").value;
              obj.customProps.price =
                parseFloat(document.getElementById("priceInput").value) || 0;
              obj.customProps.seatName =
                document.getElementById("seatNameInput").value;
              obj.item(0).set("fill", seatTypes[obj.customProps.type]);
              obj.item(1).text = obj.customProps.seatName;
            }
          });
          canvas.renderAll();
        });
      });

      // Shapes
      function addShape(shape) {
        let obj;
        if (shape === "rect")
          obj = new fabric.Rect({
            width: 100,
            height: 60,
            fill: "rgba(0,0,255,0.2)",
            stroke: "blue",
          });
        if (shape === "circle")
          obj = new fabric.Circle({
            radius: 40,
            fill: "rgba(0,0,255,0.2)",
            stroke: "blue",
          });
        if (shape === "ellipse")
          obj = new fabric.Ellipse({
            rx: 60,
            ry: 40,
            fill: "rgba(0,0,255,0.2)",
            stroke: "blue",
          });
        if (shape === "polygon")
          obj = new fabric.Polygon(
            [
              { x: 0, y: 0 },
              { x: 100, y: 0 },
              { x: 50, y: 80 },
            ],
            { fill: "rgba(0,0,255,0.2)", stroke: "blue" }
          );
        obj.left = 200;
        obj.top = 200;
        canvas.add(obj);
      }
      document.getElementById("rectTool").onclick = () => addShape("rect");
      document.getElementById("circleTool").onclick = () => addShape("circle");
      document.getElementById("ellipseTool").onclick = () =>
        addShape("ellipse");
      document.getElementById("polygonTool").onclick = () =>
        addShape("polygon");

      // Export
      document.getElementById("exportBtn").onclick = () => {
        console.log(JSON.stringify(canvas.toJSON(["customProps"])));
        alert("Check console for export!");
      };

      // Add Text
      document
        .getElementById("addTextBtn")
        .addEventListener("click", function () {
          const text = new fabric.IText("New Text", {
            left: 100,
            top: 100,
            fontSize: 20,
            fill: "#000",
            editable: true,
          });
          canvas.add(text).setActiveObject(text);
          canvas.renderAll();
        });

      setGridBackground();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
